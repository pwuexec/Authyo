@page "/roles"
@page "/organizations/{OrgId:guid}/roles"
@inject IDispatcher Dispatcher
@inject NavigationManager Navigation
@using Authy.Application.Domain.Organizations
@using Authy.Application.Domain.Roles

<PageTitle>Roles - Authy Admin</PageTitle>

<div class="page-header">
    <div class="page-header-row">
        <div>
            <h1>Roles</h1>
            <p class="page-subtitle">Manage role templates and their scope assignments.</p>
        </div>
        @if (selectedOrgId.HasValue)
        {
            <div class="page-actions">
                <NavLink href="@GetCreateRoleUrl()" class="btn btn-primary">Create Role</NavLink>
            </div>
        }
    </div>
</div>

<Alert Type="@alertType" Visible="@showAlert" Message="@alertMessage" OnDismiss="@(() => showAlert = false)" />

@if (!OrgId.HasValue)
{
    <OrganizationSelector @ref="orgSelector"
                          SelectedOrganizationId="@selectedOrgId"
                          OnSelectionChanged="OnOrganizationSelected" />
}
else
{
    <div class="breadcrumb">
        <NavLink href="/organizations">Organizations</NavLink> /
        <NavLink href="/organizations/@OrgId">@selectedOrgName</NavLink> /
        <span>Roles</span>
    </div>
}

@if (selectedOrgId.HasValue)
{
    <DataTable Items="roles" IsLoading="isLoading" TItem="GetRolesOutput" EmptyMessage="No roles found for this organization.">
        <HeaderTemplate>
            <th>Name</th>
            <th>Scopes</th>
            <th>Actions</th>
        </HeaderTemplate>
        <RowTemplate Context="role">
            <td><strong>@role.Name</strong></td>
            <td>
                <div class="scope-badges">
                    @foreach (var scope in role.Scopes.Take(3))
                    {
                        <span class="scope-badge">@scope.Name</span>
                    }
                    @if (role.Scopes.Count > 3)
                    {
                        <span class="scope-badge more">+@(role.Scopes.Count - 3) more</span>
                    }
                </div>
            </td>
            <td>
                <NavLink href="@GetEditRoleUrl(role.Name)" class="btn btn-sm btn-secondary">Edit</NavLink>
            </td>
        </RowTemplate>
    </DataTable>
}
else
{
    <p class="select-org-message">Please select an organization to view its roles.</p>
}

@code {
    [Parameter] public Guid? OrgId { get; set; }

    private OrganizationSelector? orgSelector;
    private Guid? selectedOrgId;
    private string selectedOrgName = string.Empty;
    private List<GetRolesOutput> roles = new();
    private bool isLoading = false;

    private bool showAlert = false;
    private string alertMessage = string.Empty;
    private Alert.AlertType alertType = Alert.AlertType.Info;

    // Mock user ID for authorization
    private readonly Guid mockUserId = Guid.Parse("f7fa1c38-9736-41b6-91b8-0745d0cec70e");

    protected override async Task OnParametersSetAsync()
    {
        if (OrgId.HasValue)
        {
            selectedOrgId = OrgId.Value;
            await LoadOrgNameAndRoles();
        }
    }

    private async Task LoadOrgNameAndRoles()
    {
        if (!selectedOrgId.HasValue) return;

        // Get organization name if we came from a direct URL
        if (string.IsNullOrEmpty(selectedOrgName))
        {
            var orgsResult = await Dispatcher.DispatchAsync(new GetOrganizationsQuery(), CancellationToken.None);
            if (orgsResult.IsSuccess)
            {
                var org = orgsResult.Value.FirstOrDefault(o => o.Id == selectedOrgId.Value);
                if (org != null)
                {
                    selectedOrgName = org.Name;
                }
            }
        }

        await LoadRoles();
    }

    private async Task OnOrganizationSelected(GetOrganizationsOutput? org)
    {
        if (org == null)
        {
            selectedOrgId = null;
            selectedOrgName = string.Empty;
            roles = new();
            return;
        }

        selectedOrgId = org.Id;
        selectedOrgName = org.Name;
        if (!OrgId.HasValue)
        {
            Navigation.NavigateTo($"/organizations/{selectedOrgId}/roles", replace: true);
            return;
        }
        await LoadRoles();
    }

    private async Task LoadRoles()
    {
        if (!selectedOrgId.HasValue) return;

        isLoading = true;
        var result = await Dispatcher.DispatchAsync(
            new GetRolesQuery(selectedOrgId.Value, mockUserId),
            CancellationToken.None);

        if (result.IsSuccess)
        {
            roles = result.Value;
        }
        else
        {
            ShowAlert($"Error loading roles: {result.Error.Description}", Alert.AlertType.Error);
        }
        isLoading = false;
    }

    private string GetCreateRoleUrl()
    {
        return OrgId.HasValue
            ? $"/organizations/{OrgId}/roles/new"
            : $"/organizations/{selectedOrgId}/roles/new";
    }

    private string GetEditRoleUrl(string roleName)
    {
        return OrgId.HasValue
            ? $"/organizations/{OrgId}/roles/{Uri.EscapeDataString(roleName)}/edit"
            : $"/organizations/{selectedOrgId}/roles/{Uri.EscapeDataString(roleName)}/edit";
    }

    private void ShowAlert(string message, Alert.AlertType type)
    {
        alertMessage = message;
        alertType = type;
        showAlert = true;
    }
}
