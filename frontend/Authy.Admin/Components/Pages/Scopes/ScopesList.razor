@page "/scopes"
@page "/organizations/{OrgId:guid}/scopes"
@inject IDispatcher Dispatcher
@inject NavigationManager Navigation
@using Authy.Application.Domain.Organizations
@using Authy.Application.Domain.Scopes

<PageTitle>Scopes - Authy Admin</PageTitle>

<div class="page-header">
    <div class="page-header-row">
        <div>
            <h1>Scopes</h1>
            <p class="page-subtitle">Define and manage granular permissions for your roles.</p>
        </div>
        @if (selectedOrgId.HasValue)
        {
            <div class="page-actions">
                <NavLink href="@GetCreateScopeUrl()" class="btn btn-primary">Create Scope</NavLink>
            </div>
        }
    </div>
</div>

<Alert Type="@alertType" Visible="@showAlert" Message="@alertMessage" OnDismiss="@(() => showAlert = false)" />

@if (!OrgId.HasValue)
{
    <OrganizationSelector @ref="orgSelector"
                          SelectedOrganizationId="@selectedOrgId"
                          OnSelectionChanged="OnOrganizationSelected" />
}
else
{
    <div class="breadcrumb">
        <NavLink href="/organizations">Organizations</NavLink> /
        <NavLink href="/organizations/@OrgId">@selectedOrgName</NavLink> /
        <span>Scopes</span>
    </div>
}

@if (selectedOrgId.HasValue)
{
    <DataTable Items="scopes" IsLoading="isLoading" TItem="GetScopesOutput" EmptyMessage="No scopes found for this organization.">
        <HeaderTemplate>
            <th>Name</th>
            <th>Used by Roles</th>
            <th>Actions</th>
        </HeaderTemplate>
        <RowTemplate Context="scope">
            <td><strong>@scope.Name</strong></td>
            <td>
                @if (scope.Roles.Any())
                {
                    <div class="role-badges">
                        @foreach (var role in scope.Roles.Take(3))
                        {
                            <span class="role-badge">@role.Name</span>
                        }
                        @if (scope.Roles.Count > 3)
                        {
                            <span class="role-badge more">+@(scope.Roles.Count - 3) more</span>
                        }
                    </div>
                }
                else
                {
                    <span class="no-roles">Not assigned to any role</span>
                }
            </td>
            <td>
                <NavLink href="@GetEditScopeUrl(scope.Name)" class="btn btn-sm btn-secondary">Edit</NavLink>
            </td>
        </RowTemplate>
    </DataTable>
}
else
{
    <p class="select-org-message">Please select an organization to view its scopes.</p>
}

@code {
    [Parameter] public Guid? OrgId { get; set; }

    private OrganizationSelector? orgSelector;
    private Guid? selectedOrgId;
    private string selectedOrgName = string.Empty;
    private List<GetScopesOutput> scopes = [];
    private bool isLoading = false;

    private bool showAlert = false;
    private string alertMessage = string.Empty;
    private Alert.AlertType alertType = Alert.AlertType.Info;

    // Mock user ID for authorization
    private readonly Guid mockUserId = Guid.Parse("f7fa1c38-9736-41b6-91b8-0745d0cec70e");

    protected override async Task OnParametersSetAsync()
    {
        if (OrgId.HasValue)
        {
            selectedOrgId = OrgId.Value;
            await LoadOrgNameAndScopes();
        }
    }

    private async Task LoadOrgNameAndScopes()
    {
        if (!selectedOrgId.HasValue) return;

        // Get organization name if we came from a direct URL
        if (string.IsNullOrEmpty(selectedOrgName))
        {
            var orgsResult = await Dispatcher.DispatchAsync(new GetOrganizationsQuery(), CancellationToken.None);
            if (orgsResult.IsSuccess)
            {
                var org = orgsResult.Value.FirstOrDefault(o => o.Id == selectedOrgId.Value);
                if (org != null)
                {
                    selectedOrgName = org.Name;
                }
            }
        }

        await LoadScopes();
    }

    private async Task OnOrganizationSelected(GetOrganizationsOutput? org)
    {
        if (org == null)
        {
            selectedOrgId = null;
            selectedOrgName = string.Empty;
            scopes = [];
            return;
        }

        selectedOrgId = org.Id;
        selectedOrgName = org.Name;
        if (!OrgId.HasValue)
        {
            Navigation.NavigateTo($"/organizations/{selectedOrgId}/scopes", replace: true);
            return;
        }
        await LoadScopes();
    }

    private async Task LoadScopes()
    {
        if (!selectedOrgId.HasValue) return;

        isLoading = true;
        var result = await Dispatcher.DispatchAsync(
            new GetScopesQuery(selectedOrgId.Value, mockUserId),
            CancellationToken.None);

        if (result.IsSuccess)
        {
            scopes = result.Value;
        }
        else
        {
            ShowAlert($"Error loading scopes: {result.Error.Description}", Alert.AlertType.Error);
        }
        isLoading = false;
    }

    private string GetCreateScopeUrl()
    {
        return OrgId.HasValue
            ? $"/organizations/{OrgId}/scopes/new"
            : $"/organizations/{selectedOrgId}/scopes/new";
    }

    private string GetEditScopeUrl(string scopeName)
    {
        return OrgId.HasValue
            ? $"/organizations/{OrgId}/scopes/{Uri.EscapeDataString(scopeName)}/edit"
            : $"/organizations/{selectedOrgId}/scopes/{Uri.EscapeDataString(scopeName)}/edit";
    }

    private void ShowAlert(string message, Alert.AlertType type)
    {
        alertMessage = message;
        alertType = type;
        showAlert = true;
    }
}
