@page "/scopes"
@page "/organizations/{OrgId:guid}/scopes"
@inject IDispatcher Dispatcher
@inject IAdminContext AdminContext
@inject NavigationManager Navigation
@using Authy.Application.Domain.Organizations
@using Authy.Application.Domain.Scopes

<PageTitle>Scopes - Authy Admin</PageTitle>

<h1>Scopes</h1>

<Alert Type="@alertType" Visible="@showAlert" Message="@alertMessage" OnDismiss="@(() => showAlert = false)" />

@if (!OrgId.HasValue)
{
    <OrganizationSelector @ref="orgSelector"
                          SelectedOrganizationId="@selectedOrgId"
                          OnSelectionChanged="OnOrganizationSelected" />
}
else
{
    <div class="breadcrumb">
        <a href="/organizations">Organizations</a> / <a href="/organizations/@OrgId">@selectedOrgName</a> / Scopes
    </div>
}

@if (selectedOrgId.HasValue)
{
    <div class="actions-bar">
        <a href="@GetCreateScopeUrl()" class="btn btn-primary">Create New Scope</a>
    </div>

    <DataTable Items="scopes" IsLoading="isLoading" TItem="GetScopesOutput" EmptyMessage="No scopes found for this organization.">
        <HeaderTemplate>
            <th>Name</th>
            <th>Used by Roles</th>
            <th>Actions</th>
        </HeaderTemplate>
        <RowTemplate Context="scope">
            <td><strong>@scope.Name</strong></td>
            <td>
                @if (scope.Roles.Any())
                {
                    <div class="role-badges">
                        @foreach (var role in scope.Roles.Take(3))
                        {
                            <span class="role-badge">@role.Name</span>
                        }
                        @if (scope.Roles.Count > 3)
                        {
                            <span class="role-badge more">+@(scope.Roles.Count - 3) more</span>
                        }
                    </div>
                }
                else
                {
                    <span class="no-roles">Not assigned to any role</span>
                }
            </td>
            <td>
                <a href="@GetEditScopeUrl(scope.Name)" class="btn btn-sm btn-secondary">Edit</a>
            </td>
        </RowTemplate>
    </DataTable>
}
else
{
    <p class="select-org-message">Please select an organization to view its scopes.</p>
}

@code {
    [Parameter] public Guid? OrgId { get; set; }

    private OrganizationSelector? orgSelector;
    private Guid? selectedOrgId;
    private string selectedOrgName = string.Empty;
    private List<GetScopesOutput> scopes = new();
    private bool isLoading = false;

    private bool showAlert = false;
    private string alertMessage = string.Empty;
    private Alert.AlertType alertType = Alert.AlertType.Info;

    // Mock user ID for authorization
    private readonly Guid mockUserId = Guid.Parse("f7fa1c38-9736-41b6-91b8-0745d0cec70e");

    protected override async Task OnParametersSetAsync()
    {
        if (OrgId.HasValue)
        {
            selectedOrgId = OrgId.Value;
            await LoadOrgNameAndScopes();
        }
    }

    private async Task LoadOrgNameAndScopes()
    {
        if (!selectedOrgId.HasValue) return;

        // Get organization name if we came from a direct URL
        if (string.IsNullOrEmpty(selectedOrgName))
        {
            var orgsResult = await Dispatcher.DispatchAsync(new GetOrganizationsQuery(), CancellationToken.None);
            if (orgsResult.IsSuccess)
            {
                var org = orgsResult.Value.FirstOrDefault(o => o.Id == selectedOrgId.Value);
                if (org != null)
                {
                    selectedOrgName = org.Name;
                }
            }
        }

        await LoadScopes();
    }

    private async Task OnOrganizationSelected(GetOrganizationsOutput? org)
    {
        if (org == null)
        {
            selectedOrgId = null;
            selectedOrgName = string.Empty;
            scopes = new();
            return;
        }

        selectedOrgId = org.Id;
        selectedOrgName = org.Name;
        await LoadScopes();
    }

    private async Task LoadScopes()
    {
        if (!selectedOrgId.HasValue) return;

        isLoading = true;
        var result = await Dispatcher.DispatchAsync(
            new GetScopesQuery(selectedOrgId.Value, mockUserId),
            CancellationToken.None);

        if (result.IsSuccess)
        {
            scopes = result.Value;
        }
        else
        {
            ShowAlert($"Error loading scopes: {result.Error.Description}", Alert.AlertType.Error);
        }
        isLoading = false;
    }

    private string GetCreateScopeUrl()
    {
        return OrgId.HasValue
            ? $"/organizations/{OrgId}/scopes/new"
            : $"/organizations/{selectedOrgId}/scopes/new";
    }

    private string GetEditScopeUrl(string scopeName)
    {
        return OrgId.HasValue
            ? $"/organizations/{OrgId}/scopes/{Uri.EscapeDataString(scopeName)}/edit"
            : $"/organizations/{selectedOrgId}/scopes/{Uri.EscapeDataString(scopeName)}/edit";
    }

    private void ShowAlert(string message, Alert.AlertType type)
    {
        alertMessage = message;
        alertType = type;
        showAlert = true;
    }
}

<style>
    .breadcrumb {
        margin-bottom: 1rem;
        color: #666;
    }

    .breadcrumb a {
        color: #007bff;
        text-decoration: none;
    }

    .breadcrumb a:hover {
        text-decoration: underline;
    }

    .actions-bar {
        margin-bottom: 1rem;
    }

    .btn {
        display: inline-block;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: none;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }

    .role-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
    }

    .role-badge {
        background: #d4edda;
        color: #155724;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
    }

    .role-badge.more {
        background: #6c757d;
        color: white;
    }

    .no-roles {
        color: #999;
        font-style: italic;
        font-size: 0.85rem;
    }

    .select-org-message {
        color: #666;
        text-align: center;
        padding: 2rem;
        background: white;
        border-radius: 8px;
    }
</style>

