@page "/sessions"
@page "/users/{UserId:guid}/sessions"
@inject IDispatcher Dispatcher
@inject NavigationManager Navigation
@using Authy.Application.Domain.Users
@using System.ComponentModel.DataAnnotations

<PageTitle>Sessions - Authy Admin</PageTitle>

<div class="page-header">
    <div>
        <h1>User Sessions</h1>
        <p class="page-subtitle">Review active tokens and revoke access when needed.</p>
    </div>
</div>

<Alert Type="@alertType" Visible="@showAlert" Message="@alertMessage" OnDismiss="@(() => showAlert = false)" />

@if (!UserId.HasValue)
{
    <div class="user-input-section">
        <h3>Enter User ID</h3>
        <p class="page-subtitle">Enter a user ID to view their active sessions.</p>
        <EditForm EditContext="editContext" OnValidSubmit="LoadSessionsForUser">
            <DataAnnotationsValidator />
            <ValidationSummary class="validation-summary" />
            <div class="form-group inline">
                <InputText class="form-input" @bind-Value="userLookup.UserId" placeholder="User ID (GUID)" />
                <button type="submit" class="btn btn-primary">View Sessions</button>
            </div>
            <ValidationMessage For="@(() => userLookup.UserId)" />
        </EditForm>

        <div class="quick-access">
            <p class="form-help">Quick access:</p>
            <button class="btn btn-secondary btn-sm" @onclick="UseTestUser">
                Use Test User (f7fa1c38-9736-41b6-91b8-0745d0cec70e)
            </button>
        </div>
    </div>
}
else
{
    <div class="breadcrumb">
        <NavLink href="/sessions">Sessions</NavLink> / <span>User @UserId</span>
    </div>
}

@if (selectedUserId.HasValue)
{
    <div class="user-info">
        <strong>User ID:</strong> <code>@selectedUserId</code>
        @if (!UserId.HasValue)
        {
            <button class="btn btn-sm btn-secondary" @onclick="ClearUser">Change User</button>
        }
    </div>

    <DataTable Items="sessions" IsLoading="isLoading" TItem="RefreshToken" EmptyMessage="No sessions found for this user.">
        <HeaderTemplate>
            <th>Status</th>
            <th>Created</th>
            <th>Expires</th>
            <th>IP Address</th>
            <th>User Agent</th>
            <th>Actions</th>
        </HeaderTemplate>
        <RowTemplate Context="session">
            <td>
                @if (session.IsRevoked)
                {
                    <span class="status-badge revoked">Revoked</span>
                }
                else if (session.IsExpired(DateTime.UtcNow))
                {
                    <span class="status-badge expired">Expired</span>
                }
                else
                {
                    <span class="status-badge active">Active</span>
                }
            </td>
            <td>@session.CreatedOn.ToString("yyyy-MM-dd HH:mm:ss")</td>
            <td>@session.ExpiresOn.ToString("yyyy-MM-dd HH:mm:ss")</td>
            <td><code>@(string.IsNullOrEmpty(session.IpAddress) ? "N/A" : session.IpAddress)</code></td>
            <td class="user-agent-cell">
                <span title="@session.UserAgent">
                    @TruncateUserAgent(session.UserAgent)
                </span>
            </td>
            <td>
                @if (!session.IsRevoked)
                {
                    <button class="btn btn-sm btn-danger" @onclick="() => ShowRevokeConfirm(session)">
                        Revoke
                    </button>
                }
                else
                {
                    <span class="revoked-info">Revoked @session.RevokedOn?.ToString("MM/dd")</span>
                }
            </td>
        </RowTemplate>
    </DataTable>

    <ConfirmDialog Visible="@showRevokeConfirm"
                   Title="Revoke Session"
                   Message="@($"Are you sure you want to revoke this session? The user will be logged out from this device.")"
                   ConfirmText="Revoke Session"
                   IsProcessing="@isRevoking"
                   OnConfirm="RevokeSession"
                   OnCancel="HideRevokeConfirm" />
}

@code {
    [Parameter] public Guid? UserId { get; set; }

    private Guid? selectedUserId;
    private readonly UserLookupModel userLookup = new();
    private EditContext? editContext;
    private List<RefreshToken> sessions = new();
    private RefreshToken? sessionToRevoke;
    private bool isLoading = false;
    private bool isRevoking = false;
    private bool showRevokeConfirm = false;

    private bool showAlert = false;
    private string alertMessage = string.Empty;
    private Alert.AlertType alertType = Alert.AlertType.Info;

    // Mock requesting user ID for authorization
    private readonly Guid mockRequestingUserId = Guid.Parse("f7fa1c38-9736-41b6-91b8-0745d0cec70e");

    protected override void OnInitialized()
    {
        editContext = new EditContext(userLookup);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (UserId.HasValue)
        {
            selectedUserId = UserId.Value;
            await LoadSessions();
        }
    }

    private void UseTestUser()
    {
        userLookup.UserId = "f7fa1c38-9736-41b6-91b8-0745d0cec70e";
        editContext?.NotifyFieldChanged(new FieldIdentifier(userLookup, nameof(UserLookupModel.UserId)));
    }

    private async Task LoadSessionsForUser()
    {
        var parsedUserId = Guid.Parse(userLookup.UserId);

        selectedUserId = parsedUserId;
        Navigation.NavigateTo($"/users/{selectedUserId}/sessions", replace: true);
    }

    private async Task LoadSessions()
    {
        if (!selectedUserId.HasValue) return;

        isLoading = true;
        var result = await Dispatcher.DispatchAsync(
            new GetSessionsQuery(selectedUserId.Value, mockRequestingUserId),
            CancellationToken.None);

        if (result.IsSuccess)
        {
            sessions = result.Value.OrderByDescending(s => s.CreatedOn).ToList();
        }
        else
        {
            ShowAlert($"Error loading sessions: {result.Error.Description}", Alert.AlertType.Error);
        }
        isLoading = false;
    }

    private void ClearUser()
    {
        selectedUserId = null;
        userLookup.UserId = string.Empty;
        editContext?.NotifyFieldChanged(new FieldIdentifier(userLookup, nameof(UserLookupModel.UserId)));
        sessions = new();
        Navigation.NavigateTo("/sessions", replace: true);
    }

    private void ShowRevokeConfirm(RefreshToken session)
    {
        sessionToRevoke = session;
        showRevokeConfirm = true;
    }

    private void HideRevokeConfirm()
    {
        sessionToRevoke = null;
        showRevokeConfirm = false;
    }

    private async Task RevokeSession()
    {
        if (sessionToRevoke == null) return;

        isRevoking = true;
        var result = await Dispatcher.DispatchAsync(
            new RevokeSessionCommand(sessionToRevoke.Id, mockRequestingUserId),
            CancellationToken.None);

        if (result.IsSuccess)
        {
            ShowAlert("Session revoked successfully.", Alert.AlertType.Success);
            await LoadSessions();
        }
        else
        {
            ShowAlert($"Error revoking session: {result.Error.Description}", Alert.AlertType.Error);
        }

        isRevoking = false;
        HideRevokeConfirm();
    }

    private string TruncateUserAgent(string userAgent)
    {
        if (string.IsNullOrEmpty(userAgent)) return "N/A";
        return userAgent.Length > 40 ? userAgent.Substring(0, 40) + "..." : userAgent;
    }

    private void ShowAlert(string message, Alert.AlertType type)
    {
        alertMessage = message;
        alertType = type;
        showAlert = true;
    }

    private sealed class UserLookupModel : IValidatableObject
    {
        [Required(ErrorMessage = "User ID is required.")]
        public string UserId { get; set; } = string.Empty;

        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            if (!Guid.TryParse(UserId, out _))
            {
                yield return new ValidationResult("Enter a valid GUID.", new[] { nameof(UserId) });
            }
        }
    }
}
