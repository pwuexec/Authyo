@page "/sessions"
@page "/users/{UserId:guid}/sessions"
@inject IDispatcher Dispatcher
@inject IAdminContext AdminContext
@inject NavigationManager Navigation
@using Authy.Application.Domain.Users

<PageTitle>Sessions - Authy Admin</PageTitle>

<h1>User Sessions</h1>

<Alert Type="@alertType" Visible="@showAlert" Message="@alertMessage" OnDismiss="@(() => showAlert = false)" />

@if (!UserId.HasValue)
{
    <div class="user-input-section">
        <h3>Enter User ID</h3>
        <p class="help-text">Enter a user ID to view their active sessions.</p>
        <form @onsubmit="LoadSessionsForUser">
            <div class="form-group">
                <input type="text" @bind="userIdInput" placeholder="User ID (GUID)" class="form-input" />
                <button type="submit" class="btn btn-primary">View Sessions</button>
            </div>
        </form>

        <div class="quick-access">
            <p>Quick access:</p>
            <button class="btn btn-secondary btn-sm" @onclick="UseTestUser">
                Use Test User (f7fa1c38-9736-41b6-91b8-0745d0cec70e)
            </button>
        </div>
    </div>
}
else
{
    <div class="breadcrumb">
        <a href="/sessions">Sessions</a> / User @UserId
    </div>
}

@if (selectedUserId.HasValue)
{
    <div class="user-info">
        <strong>User ID:</strong> <code>@selectedUserId</code>
        @if (!UserId.HasValue)
        {
            <button class="btn btn-sm btn-secondary" @onclick="ClearUser">Change User</button>
        }
    </div>

    <DataTable Items="sessions" IsLoading="isLoading" TItem="RefreshToken" EmptyMessage="No sessions found for this user.">
        <HeaderTemplate>
            <th>Status</th>
            <th>Created</th>
            <th>Expires</th>
            <th>IP Address</th>
            <th>User Agent</th>
            <th>Actions</th>
        </HeaderTemplate>
        <RowTemplate Context="session">
            <td>
                @if (session.IsRevoked)
                {
                    <span class="status-badge revoked">Revoked</span>
                }
                else if (session.IsExpired(DateTime.UtcNow))
                {
                    <span class="status-badge expired">Expired</span>
                }
                else
                {
                    <span class="status-badge active">Active</span>
                }
            </td>
            <td>@session.CreatedOn.ToString("yyyy-MM-dd HH:mm:ss")</td>
            <td>@session.ExpiresOn.ToString("yyyy-MM-dd HH:mm:ss")</td>
            <td><code>@(string.IsNullOrEmpty(session.IpAddress) ? "N/A" : session.IpAddress)</code></td>
            <td class="user-agent-cell">
                <span title="@session.UserAgent">
                    @TruncateUserAgent(session.UserAgent)
                </span>
            </td>
            <td>
                @if (!session.IsRevoked)
                {
                    <button class="btn btn-sm btn-danger" @onclick="() => ShowRevokeConfirm(session)">
                        Revoke
                    </button>
                }
                else
                {
                    <span class="revoked-info">Revoked @session.RevokedOn?.ToString("MM/dd")</span>
                }
            </td>
        </RowTemplate>
    </DataTable>

    <ConfirmDialog Visible="@showRevokeConfirm"
                   Title="Revoke Session"
                   Message="@($"Are you sure you want to revoke this session? The user will be logged out from this device.")"
                   ConfirmText="Revoke Session"
                   IsProcessing="@isRevoking"
                   OnConfirm="RevokeSession"
                   OnCancel="HideRevokeConfirm" />
}

@code {
    [Parameter] public Guid? UserId { get; set; }

    private Guid? selectedUserId;
    private string userIdInput = string.Empty;
    private List<RefreshToken> sessions = [];
    private RefreshToken? sessionToRevoke;
    private bool isLoading = false;
    private bool isRevoking = false;
    private bool showRevokeConfirm = false;

    private bool showAlert = false;
    private string alertMessage = string.Empty;
    private Alert.AlertType alertType = Alert.AlertType.Info;

    // Mock requesting user ID for authorization
    private readonly Guid mockRequestingUserId = Guid.Parse("f7fa1c38-9736-41b6-91b8-0745d0cec70e");

    protected override async Task OnParametersSetAsync()
    {
        if (UserId.HasValue)
        {
            selectedUserId = UserId.Value;
            await LoadSessions();
        }
    }

    private void UseTestUser()
    {
        userIdInput = "f7fa1c38-9736-41b6-91b8-0745d0cec70e";
    }

    private async Task LoadSessionsForUser()
    {
        if (string.IsNullOrWhiteSpace(userIdInput))
        {
            ShowAlert("Please enter a user ID.", Alert.AlertType.Warning);
            return;
        }

        if (!Guid.TryParse(userIdInput, out var parsedUserId))
        {
            ShowAlert("Invalid user ID format. Please enter a valid GUID.", Alert.AlertType.Error);
            return;
        }

        selectedUserId = parsedUserId;
        await LoadSessions();
    }

    private async Task LoadSessions()
    {
        if (!selectedUserId.HasValue) return;

        isLoading = true;
        var result = await Dispatcher.DispatchAsync(
            new GetSessionsQuery(selectedUserId.Value, mockRequestingUserId),
            CancellationToken.None);

        if (result.IsSuccess)
        {
            sessions = result.Value.OrderByDescending(s => s.CreatedOn).ToList();
        }
        else
        {
            ShowAlert($"Error loading sessions: {result.Error.Description}", Alert.AlertType.Error);
        }
        isLoading = false;
    }

    private void ClearUser()
    {
        selectedUserId = null;
        userIdInput = string.Empty;
        sessions = [];
    }

    private void ShowRevokeConfirm(RefreshToken session)
    {
        sessionToRevoke = session;
        showRevokeConfirm = true;
    }

    private void HideRevokeConfirm()
    {
        sessionToRevoke = null;
        showRevokeConfirm = false;
    }

    private async Task RevokeSession()
    {
        if (sessionToRevoke == null) return;

        isRevoking = true;
        var result = await Dispatcher.DispatchAsync(
            new RevokeSessionCommand(sessionToRevoke.Id, mockRequestingUserId),
            CancellationToken.None);

        if (result.IsSuccess)
        {
            ShowAlert("Session revoked successfully.", Alert.AlertType.Success);
            await LoadSessions();
        }
        else
        {
            ShowAlert($"Error revoking session: {result.Error.Description}", Alert.AlertType.Error);
        }

        isRevoking = false;
        HideRevokeConfirm();
    }

    private string TruncateUserAgent(string userAgent)
    {
        if (string.IsNullOrEmpty(userAgent)) return "N/A";
        return userAgent.Length > 40 ? userAgent.Substring(0, 40) + "..." : userAgent;
    }

    private void ShowAlert(string message, Alert.AlertType type)
    {
        alertMessage = message;
        alertType = type;
        showAlert = true;
    }
}

<style>
    .breadcrumb {
        margin-bottom: 1rem;
        color: #666;
    }

    .breadcrumb a {
        color: #007bff;
        text-decoration: none;
    }

    .user-input-section {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        max-width: 600px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .user-input-section h3 {
        margin: 0 0 0.5rem 0;
    }

    .help-text {
        color: #666;
        margin-bottom: 1rem;
    }

    .form-group {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .form-input {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
        font-family: monospace;
    }

    .quick-access {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #eee;
    }

    .quick-access p {
        margin: 0 0 0.5rem 0;
        color: #666;
        font-size: 0.85rem;
    }

    .user-info {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .user-info code {
        background: #e9ecef;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-size: 0.85rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: none;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }

    .status-badge {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-badge.active {
        background: #d4edda;
        color: #155724;
    }

    .status-badge.expired {
        background: #fff3cd;
        color: #856404;
    }

    .status-badge.revoked {
        background: #f8d7da;
        color: #721c24;
    }

    .user-agent-cell {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .revoked-info {
        color: #999;
        font-size: 0.8rem;
    }

    code {
        background: #f4f4f4;
        padding: 0.1rem 0.3rem;
        border-radius: 3px;
        font-size: 0.8rem;
    }
</style>

