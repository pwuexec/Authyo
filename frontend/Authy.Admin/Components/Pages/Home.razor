@page "/"
@inject IDispatcher Dispatcher
@inject IAdminContext AdminContext
@using Authy.Application.Domain.Organizations

<PageTitle>Dashboard - Authy Admin</PageTitle>

<div class="page-header">
    <div class="page-header-row">
        <div>
            <h1>Dashboard</h1>
            <p class="page-subtitle">Welcome back. Manage organizations, roles, scopes, and sessions in one place.</p>
        </div>
    </div>
</div>

<div class="welcome-section">
    <p>Use the quick actions below to keep identity workflows moving.</p>
    @if (AdminContext.IsRootUser)
    {
        <p class="root-notice">You are accessing as a <strong>root user</strong> with full administrative privileges.</p>
    }
</div>

@if (isLoading)
{
    <LoadingSpinner IsLoading="true" Message="Loading statistics..." />
}
else
{
    <div class="stats-grid">
        @if (AdminContext.IsRootUser)
        {
            <div class="stat-card">
                <h3>Organizations</h3>
                <div class="stat-value">@organizationCount</div>
                <NavLink href="/organizations" class="stat-link">Manage Organizations</NavLink>
            </div>
        }

        <div class="stat-card">
            <h3>Roles</h3>
            <div class="stat-value">-</div>
            <NavLink href="/roles" class="stat-link">Manage Roles</NavLink>
        </div>

        <div class="stat-card">
            <h3>Scopes</h3>
            <div class="stat-value">-</div>
            <NavLink href="/scopes" class="stat-link">Manage Scopes</NavLink>
        </div>

        <div class="stat-card">
            <h3>Sessions</h3>
            <div class="stat-value">-</div>
            <NavLink href="/sessions" class="stat-link">View Sessions</NavLink>
        </div>
    </div>

    <div class="quick-actions">
        <h2>Quick Actions</h2>
        <div class="action-buttons">
            @if (AdminContext.IsRootUser)
            {
                <NavLink href="/organizations" class="action-btn">
                    <span class="action-icon">+</span>
                    <span>Create Organization</span>
                </NavLink>
            }
            <NavLink href="/roles" class="action-btn">
                <span class="action-icon">+</span>
                <span>Create Role</span>
            </NavLink>
            <NavLink href="/scopes" class="action-btn">
                <span class="action-icon">+</span>
                <span>Create Scope</span>
            </NavLink>
            <NavLink href="/sessions" class="action-btn">
                <span class="action-icon">~</span>
                <span>View Sessions</span>
            </NavLink>
        </div>
    </div>

    @if (AdminContext.IsRootUser && organizations.Any())
    {
        <div class="recent-section">
            <h2>Organizations</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>ID</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var org in organizations.Take(5))
                        {
                            <tr>
                                <td><strong>@org.Name</strong></td>
                                <td><code>@org.Id</code></td>
                                <td>
                                    <NavLink href="/organizations/@org.Id" class="link">View</NavLink> |
                                    <NavLink href="/organizations/@org.Id/roles" class="link">Roles</NavLink> |
                                    <NavLink href="/organizations/@org.Id/scopes" class="link">Scopes</NavLink>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            @if (organizations.Count > 5)
            {
                <NavLink href="/organizations" class="view-all-link">View all @organizations.Count organizations</NavLink>
            }
        </div>
    }
}

@code {
    private List<GetOrganizationsOutput> organizations = new();
    private int organizationCount = 0;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        if (AdminContext.IsRootUser)
        {
            var result = await Dispatcher.DispatchAsync(new GetOrganizationsQuery(), CancellationToken.None);
            if (result.IsSuccess)
            {
                organizations = result.Value;
                organizationCount = organizations.Count;
            }
        }
        isLoading = false;
    }
}
