@page "/organizations/{OrgId:guid}"
@inject IDispatcher Dispatcher
@inject IAdminContext AdminContext
@using Authy.Application.Domain.Organizations
@using Authy.Application.Domain.Roles
@using Authy.Application.Domain.Scopes

<PageTitle>Organization Details - Authy Admin</PageTitle>

@if (!AdminContext.IsRootUser)
{
    <Alert Type="Alert.AlertType.Error" Visible="true" Dismissible="false"
           Message="Access denied. Only root users can view organization details." />
}
else if (isLoading)
{
    <LoadingSpinner IsLoading="true" Message="Loading organization..." />
}
else if (organization == null)
{
    <Alert Type="Alert.AlertType.Error" Visible="true" Dismissible="false"
           Message="Organization not found." />
}
else
{
    <div class="breadcrumb">
        <NavLink href="/organizations">Organizations</NavLink> / <span>@organization.Name</span>
    </div>

    <div class="page-header">
        <div>
            <h1>@organization.Name</h1>
            <p class="page-subtitle"><strong>ID:</strong> <code>@organization.Id</code></p>
        </div>
    </div>

    <div class="detail-sections">
        <div class="detail-section">
            <h2>Roles (@roles.Count)</h2>
            <NavLink href="/organizations/@OrgId/roles" class="btn btn-primary">Manage Roles</NavLink>
            @if (roles.Any())
            {
                <ul class="item-list">
                    @foreach (var role in roles.Take(5))
                    {
                        <li>
                            <span class="item-name">@role.Name</span>
                            <span class="item-detail">@role.Scopes.Count scopes</span>
                        </li>
                    }
                    @if (roles.Count > 5)
                    {
                        <li class="more-items">...and @(roles.Count - 5) more</li>
                    }
                </ul>
            }
            else
            {
                <p class="empty-message">No roles defined yet.</p>
            }
        </div>

        <div class="detail-section">
            <h2>Scopes (@scopes.Count)</h2>
            <NavLink href="/organizations/@OrgId/scopes" class="btn btn-primary">Manage Scopes</NavLink>
            @if (scopes.Any())
            {
                <ul class="item-list">
                    @foreach (var scope in scopes.Take(5))
                    {
                        <li>
                            <span class="item-name">@scope.Name</span>
                            <span class="item-detail">@scope.Roles.Count roles</span>
                        </li>
                    }
                    @if (scopes.Count > 5)
                    {
                        <li class="more-items">...and @(scopes.Count - 5) more</li>
                    }
                </ul>
            }
            else
            {
                <p class="empty-message">No scopes defined yet.</p>
            }
        </div>
    </div>
}

@code {
    [Parameter] public Guid OrgId { get; set; }

    private GetOrganizationsOutput? organization;
    private List<GetRolesOutput> roles = new();
    private List<GetScopesOutput> scopes = new();
    private bool isLoading = true;

    protected override async Task OnParametersSetAsync()
    {
        if (!AdminContext.IsRootUser)
        {
            isLoading = false;
            return;
        }

        await LoadOrganizationDetails();
    }

    private async Task LoadOrganizationDetails()
    {
        isLoading = true;

        // Load organizations to find the one we need
        var orgsResult = await Dispatcher.DispatchAsync(new GetOrganizationsQuery(), CancellationToken.None);
        if (orgsResult.IsSuccess)
        {
            organization = orgsResult.Value.FirstOrDefault(o => o.Id == OrgId);
        }

        if (organization != null)
        {
            // We need a user ID to query roles and scopes - use mock user ID for now
            var mockUserId = Guid.Parse("f7fa1c38-9736-41b6-91b8-0745d0cec70e");

            var rolesTask = Dispatcher.DispatchAsync(new GetRolesQuery(OrgId, mockUserId), CancellationToken.None);
            var scopesTask = Dispatcher.DispatchAsync(new GetScopesQuery(OrgId, mockUserId), CancellationToken.None);

            await Task.WhenAll(rolesTask, scopesTask);

            if (rolesTask.Result.IsSuccess)
            {
                roles = rolesTask.Result.Value;
            }

            if (scopesTask.Result.IsSuccess)
            {
                scopes = scopesTask.Result.Value;
            }
        }

        isLoading = false;
    }
}
